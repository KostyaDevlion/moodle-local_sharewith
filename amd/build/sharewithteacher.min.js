define ("local_sharewith/sharewithteacher",["jquery","core/ajax","core/notification","local_sharewith/modal"],function(a,b,c,d){var e={root:"body"},f={};return{resultBlock:"",tagWrapper:"",input:"",numOfSings:3,init:function init(){var b=a(e.root)[0];b.addEventListener("click",function(a){var c=a.target;while(b.contains(c)){switch(c.dataset.handler){case"addTag":this.addTag(c);break;case"removeTag":this.removeTag(c);break;case"sendLinkToTeachers":this.submitTeachers();break;case"shareActivity":this.shareActivity(c);break;}c=c.parentNode}}.bind(this));b.addEventListener("input",function(a){var c=a.target;while(b.contains(c)){switch(c.dataset.handler){case"selectTeacher":this.autocompleteTeachers(c);break;}c=c.parentNode}}.bind(this))},shareActivity:function shareActivity(e){f.cmid=a(e).attr("data-cmid");f.courseid=this.getCurrentCourse();var g=this;b.call([{methodname:"local_sharewith_get_teachers",args:{activityid:+f.cmid,courseid:+f.courseid},done:function renderPopup(a){var b=JSON.parse(a);d.render(d.template.shareteacher,b).done(function(){g.resultBlock=document.querySelector(".result-block");g.tagWrapper=document.querySelector(".tag-wrapper");g.input=document.querySelector("input[data-handler = \"selectTeacher\"]");d.triggerBtn.click()})},fail:c.exception}])},keySelect:function keySelect(a){var b=0,c=document.querySelector(".tag-wrapper"),d=Array.from(a.children);d.forEach(function(a){a.tabIndex=0});a.onmouseover=function(a){a.target.focus();d.forEach(function(a,c){a.onfocus=function(){b=c}})};var e=function(){d[b].blur()},f=function(){d[b].focus()},g=function(){if(0>=b){}else{e();b--;f()}},h=function(){if(b>=d.length-1){}else{e();b++;f()}},i=function(){var a=new Event("click",{bubbles:!0});d[b].dispatchEvent(a)},j=function(){a.innerHTML="";a.classList.add("d-none");b=-1;document.removeEventListener("click",l);document.removeEventListener("keydown",k)},k=function(a){switch(a.keyCode){case 38:g();break;case 40:h();break;case 13:i();break;case 27:j();break;}},l=function(b){if(a.contains(b.target)||-1!=b.path.indexOf(c)){return}j()};document.addEventListener("click",l);document.addEventListener("keydown",k)},showSearchResult:function showSearchResult(a){this.resultBlock.innerHTML="";var b=JSON.parse(a);b.forEach(function(a){var b=document.createElement("li");b.dataset.teacherid=a.id;b.dataset.teachername=a.teacher_name;b.dataset.handler="addTag";b.classList.add("btn","btn-secondary","d-flex","mb-1");b.innerHTML="<div class = \"sw-img\" ><img src = \""+M.cfg.wwwroot+a.teacher_url+"\" alt = \"\"></div><span class = \"pl-2\">"+a.teacher_name+"</span>";if(this.tagWrapper.querySelector(".btn[data-id=\""+a.id+"\"]")){b.classList.add("active")}this.resultBlock.classList.remove("d-none");this.resultBlock.appendChild(b)}.bind(this));this.keySelect(this.resultBlock)},autocompleteTeachers:function autocompleteTeachers(a){var d=a.value;if(!this.resultBlock.childElementCount&&!d){this.resultBlock.classList.add("d-none")}if(d.length>=this.numOfSings){b.call([{methodname:"local_sharewith_autocomplete_teachers",args:{searchstring:d},done:this.showSearchResult.bind(this),fail:c.exception}])}},submitTeachers:function submitTeachers(){var a=d.modalWrapper.querySelector("form"),e=new FormData(a);if(!this.isValidData(e)){return}d.addBtnSpinner();b.call([{methodname:"local_sharewith_submit_teachers",args:{activityid:f.cmid,courseid:f.courseid,teachersid:JSON.stringify(e.getAll("teacherid")),message:e.get("message")},done:function renderPopup(a){var b=d.template.error,c={title:M.util.get_string("eventcopytoteacher","local_sharewith"),text:M.util.get_string("system_error_contact_administrator","local_sharewith")};if(!a.status){c.text=a.message}else{b=d.template.confirm;c.text=M.util.get_string("succesfullyshared","local_sharewith")}d.render(b,c)},fail:c.exception}])},addTag:function addTag(b){var c=b.dataset.teacherid,d=a(this.tagWrapper).find("[data-teacherid="+c+"]");if(d.length){this.removeTag(d[0]);return}var e=a(this.tagWrapper).find(".example").clone();a(e).attr("data-teacherid",c);a(e).find("input").attr("value",c).attr("checked","checked");e.append("<span>"+b.dataset.teachername+"</span>");e.removeClass("example d-none");b.classList.add("active");a(this.tagWrapper).append(e);this.input.value=""},removeTag:function removeTag(b){var c=b.dataset.teacherid;a(this.resultBlock).find("[data-teacherid="+c+"]").removeClass("active");a(b).remove()},isValidData:function isValidData(b){var c=[];if(!b.getAll("teacherid").length){c.push(a("#selectteacher"))}c.forEach(function(b){a(b).popover({template:"<div class=\"popover\" role=\"tooltip\"><div class=\"arrow\"></div><div class=\"popover-body text-danger\" style=\"font-size:1rem;\"></div></div>"});a(b).popover("show");a(b).on("click remove",function(){a(this).popover("hide")})});return c.length?!1:!0},getCurrentCourse:function getCurrentCourse(){var b=a("body").attr("class"),c=b.match(/course-\d+/gi)[0].replace(/\D+/,"");return c}}});
//# sourceMappingURL=sharewithteacher.min.js.map
