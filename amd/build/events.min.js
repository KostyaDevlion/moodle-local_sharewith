define(["jquery","core/str","core/ajax","local_sharewith/modal"],function(a,b,c,d){return{ICON:{spinner:"circle-loading",component:"local_sharewith"},selectCategory:function(){var e=d.getBody(),f=function(c){var f=Object.values(JSON.parse(c.categories));d.init(),b.get_string("selectioncategories","local_sharewith").done(function(a){d.getTitle().text(a)}),e.append(a('<select class = "categories form-control"></select>')),f.forEach(function(b){e.find(".categories").append(a("<option data-categoryid ="+b.id+">"+b.name+"</option>"))}),this.setHandler("copyCourseToCategory")}.bind(this);c.call([{methodname:"get_categories",args:{},done:f,fail:f}])},copyCourseToCategory:function(){var a=this,e=d.getModal().find(":selected").attr("data-categoryid"),f=d.getBody();a.addSpinner(f);var g=function(a){a.result?(d.approveState(),b.get_string("course_copied_to_section","local_sharewith").done(function(a){f.text(a)})):d.errorState()};c.call([{methodname:"add_sharewith_task",args:{sourcecourseid:Number(this.getCurrentCourse()),categoryid:Number(e),type:"coursecopy"},done:g,fail:g}])},selectCourse:function(e){var f=a(e).parents(".activity").find('[data-itemtype="activityname"]').data("itemid"),g=a(e).parents(".section").find('[data-itemtype="sectionname"]').data("itemid"),h=d.getBody(),i=function(c){var i=JSON.parse(c.courses);d.init(),"copySection"===a(e).data("ref")?(this.setHandler("copySectionToCourse"),b.get_string("selectcourse","local_sharewith").done(function(a){d.getTitle().text(a)})):(this.setHandler("copySectionToCourse"),b.get_string("selectcourse_and_section","local_sharewith").done(function(a){d.getTitle().text(a)})),h.append(a('<p>select course</p><select data-handler="selectSection" class = "courses form-control"></select>')).attr("data-cmid",f).attr("data-sectionid",g).css("min-height","100px"),i.forEach(function(b){h.find(".courses").append(a("<option data-courseid ="+b.id+">"+b.fullname+"</option>"))}),"copySection"!==a(e).data("ref")&&(h.append(a('<p>select section</p><select class = "sections form-control"></select>')),this.setHandler("copyActivityToCourse"),this.selectSection(a('[data-handler="selectSection"]')))}.bind(this);c.call([{methodname:"get_courses",args:{},done:i,fail:i}])},selectSection:function(){var b=d.getBody(),e=b.find(":selected").attr("data-courseid"),f=function(c){var d=JSON.parse(c.sections);b.find(".sections").html(""),d.forEach(function(c){b.find(".sections").append(a("<option data-sectionid ="+c.section_id+">"+c.section_name+"</option>"))})};c.call([{methodname:"get_sections",args:{courseid:Number(e)},done:f,fail:f}])},copyActivityToCourse:function(){var a=d.getBody(),e=a.data("cmid"),f=a.find(":selected")[0].dataset.courseid,g=a.find(":selected")[0].innerHTML,h=a.find(":selected")[1].dataset.sectionid,i=function(c){c.result?(d.approveState(),b.get_string("activity_copied_to_course","local_sharewith").done(function(b){a.text(b+" "+g)})):d.errorState()};c.call([{methodname:"add_sharewith_task",args:{courseid:Number(f),sourcecourseid:Number(this.getCurrentCourse()),sectionid:Number(h),sourceactivityid:Number(e),type:"activityhimselfcopy"},done:i,fail:i}])},copySectionToCourse:function(){var a=d.getBody(),e=a.data("sectionid"),f=a.find(":selected").data("courseid"),g=a.find(":selected").text(),h=function(c){c.result?(d.approveState(),b.get_string("section_copied_to_course","local_sharewith").done(function(b){a.text(b+" "+g)})):d.errorState()};c.call([{methodname:"add_sharewith_task",args:{courseid:Number(f),sourcecourseid:Number(this.getCurrentCourse()),sourcesectionid:Number(e),type:"sectioncopy"},done:h,fail:h}])},addSpinner:function(b){var c=a("<img/>").attr("src",M.util.image_url(this.ICON.spinner,this.ICON.component)).addClass("mx-auto spinner");return b.html(""),b.append(c),c.fadeIn().css("display","block"),c},getCurrentCourse:function(){var b=a("body").attr("class"),c=b.match(/course-\d+/gi)[0].replace(/\D+/,"");return c},setHandler:function(a){d.getSubmit().attr("data-handler",a)}}});