define(["jquery","core/str","core/ajax","local_sharewith/modal","core/notification"],function(r,s,u,h,p){return s.get_strings([{key:"sent",component:"local_sharewith"},{key:"fails",component:"local_sharewith"},{key:"sharing_sent_successfully",component:"local_sharewith"}]).done(),{ICON:{spinner:"circle-loading",component:"local_sharewith"},selectCategory:function(){var a=h.getBody(),e=function(e){var t=Object.values(JSON.parse(e.categories));h.init(),s.get_string("selectioncategories","local_sharewith").done(function(e){h.getTitle().text(e)}),a.append(r('<select class = "categories form-control"></select>')),t.forEach(function(e){a.find(".categories").append(r("<option data-categoryid ="+e.id+">"+e.name+"</option>"))}),this.setHandler("copyCourseToCategory")}.bind(this);u.call([{methodname:"local_sharewith_get_categories",args:{},done:e,fail:e}])},copyCourseToCategory:function(){var e=h.getModal().find(":selected").attr("data-categoryid"),t=h.getBody();this.addSpinner(t);function a(e){e.result?(s.get_string("succesfullycopied","local_sharewith").done(function(e){t.text(e)}),h.approveState()):(h.errorTextState(),t.text(e.text))}u.call([{methodname:"local_sharewith_add_sharewith_task",args:{sourcecourseid:Number(this.getCurrentCourse()),categoryid:Number(e),type:"coursecopy"},done:a,fail:a}])},selectCourse:function(a){var n=r(a).parents(".activity").find('[data-itemtype="activityname"]').data("itemid"),o=r(a).parents(".section").find('[data-itemtype="sectionname"]').data("itemid"),i=h.getBody(),e=function(e){var t=JSON.parse(e.courses);h.init(),"copySection"===r(a).data("ref")?(this.setHandler("copySectionToCourse"),s.get_string("selectcourse","local_sharewith").done(function(e){h.getTitle().text(e)})):(this.setHandler("copySectionToCourse"),s.get_string("selectcourse_and_section","local_sharewith").done(function(e){h.getTitle().text(e)})),i.append(r('<p>select course</p><select data-handler="selectSection" class = "courses form-control"></select>')).attr("data-cmid",n).attr("data-sectionid",o).css("min-height","100px"),t.forEach(function(e){i.find(".courses").append(r("<option data-courseid ="+e.id+">"+e.fullname+"</option>"))}),"copySection"!==r(a).data("ref")&&(i.append(r('<p>select section</p><select class = "sections form-control"></select>')),this.setHandler("copyActivityToCourse"),this.selectSection(r('[data-handler="selectSection"]')))}.bind(this);u.call([{methodname:"local_sharewith_get_courses",args:{},done:e,fail:e}])},selectSection:function(){function e(e){var t=JSON.parse(e.sections);a.find(".sections").html(""),t.forEach(function(e){a.find(".sections").append(r("<option data-sectionid ="+e.section_id+">"+e.section_name+"</option>"))})}var a=h.getBody(),t=a.find(":selected").attr("data-courseid");u.call([{methodname:"local_sharewith_get_sections",args:{courseid:Number(t)},done:e,fail:e}])},selectTeacher:function(e){var a=r(e).parents(".activity").find('[data-itemtype="activityname"]').data("itemid"),t=r("#course").val(),n=h.getBody();h.cancelState();var o=function(e){var t=JSON.parse(e);h.init(),this.setHandler("copySectionToCourse"),s.get_string("selectteacher","local_sharewith").done(function(e){h.getTitle().text(e)}),n.append(t.html),this.selectDestination(a)}.bind(this);u.call([{methodname:"local_sharewith_get_teachers",args:{activityid:a,courseid:t},done:o,fail:o}])},saveActivity:function(a){var n=a.dataset.sharing,o=h.getBody(),e=function(e){var t=JSON.parse(e.courses);h.init(),o.append(r('<input type="hidden" name="shareid" value="'+n+'">')),"copySection"===r(a).data("ref")?(this.setHandler("copySectionToCourse"),s.get_string("selectcourse","local_sharewith").done(function(e){h.getTitle().text(e)})):(this.setHandler("copySectionToCourse"),s.get_string("selectcourse_and_section","local_sharewith").done(function(e){h.getTitle().text(e)})),o.append(r('<p>select course</p><select data-handler="selectSection" class = "courses form-control"></select>')).css("min-height","100px"),t.forEach(function(e){o.find(".courses").append(r("<option data-courseid ="+e.id+">"+e.fullname+"</option>"))}),"copySection"!==r(a).data("ref")&&(o.append(r('<p>select section</p><select class = "sections form-control"></select>')),this.setHandler("saveActivityToCourse"),this.selectSection(r('[data-handler="selectSection"]')))}.bind(this);u.call([{methodname:"local_sharewith_get_courses",args:{},done:e,fail:e}])},saveActivityToCourse:function(){function e(e){0<e.result?(s.get_string("succesfullyshared","local_sharewith").done(function(e){t.text(e)}),h.approveState()):(h.errorTextState(),t.text(e.text))}var t=h.getBody(),a=r('input[name="shareid"]').val(),n=t.find(":selected")[0].dataset.courseid,o=t.find(":selected")[1].dataset.sectionid;u.call([{methodname:"local_sharewith_add_saveactivity_task",args:{courseid:Number(n),sectionid:Number(o),shareid:Number(a),type:"activityshare"},done:e,fail:e}])},copyActivityToCourse:function(){function e(e){e.result?(s.get_string("succesfullycopied","local_sharewith").done(function(e){t.text(e)}),h.approveState()):(h.errorTextState(),t.text(e.text))}var t=h.getBody(),a=t.data("cmid"),n=t.find(":selected")[0].dataset.courseid,o=t.find(":selected")[1].dataset.sectionid;u.call([{methodname:"local_sharewith_add_sharewith_task",args:{courseid:Number(n),sourcecourseid:Number(this.getCurrentCourse()),sectionid:Number(o),sourceactivityid:Number(a),type:"activitycopy"},done:e,fail:e}])},copySectionToCourse:function(){function e(e){e.result?(s.get_string("succesfullycopied","local_sharewith").done(function(e){t.text(e)}),h.approveState()):(h.errorTextState(),t.text(e.text))}var t=h.getBody(),a=t.data("sectionid"),n=t.find(":selected").data("courseid");u.call([{methodname:"local_sharewith_add_sharewith_task",args:{courseid:Number(n),sourcecourseid:Number(this.getCurrentCourse()),sourcesectionid:Number(a),type:"sectioncopy"},done:e,fail:e}])},addSpinner:function(e){var t=r("<img/>").attr("src",M.util.image_url(this.ICON.spinner,this.ICON.component)).addClass("mx-auto spinner");return e.html(""),e.append(t),t.fadeIn().css("display","block"),t},getCurrentCourse:function(){return r("body").attr("class").match(/course-\d+/gi)[0].replace(/\D+/,"")},setHandler:function(e){h.getSubmit().attr("data-handler",e)},selectDestination:function(a){var e=document.querySelector(".prof__form"),o=document.querySelector("input.prof__input"),d=document.querySelector(".prof__tag-wrap"),l=document.createElement("ul"),s=document.querySelector("#btnSendResult");if(e){l.classList.add("dest__result-block"),e.appendChild(l);function i(t,e){Array.from(document.querySelectorAll("form")).forEach(function(e){e.contains(t)&&(e.onkeydown=function(e){13==e.keyCode&&e.preventDefault()})});var a=0,n=Array.from(t.children);n.forEach(function(e){e.tabIndex=0}),t.onmouseover=function(e){e.target.focus(),n.forEach(function(e,t){e.onfocus=function(){a=t}})};function o(){n[a].blur()}function i(){n[a].focus()}var s=function(){a<=0||(n[a-1].classList.contains("dest__selected")?(a--,s()):(o(),a--,i()))},c=function(){a>=n.length-1||(n[a+1].classList.contains("dest__selected")?(a++,c()):(o(),a++,i()))},r=function(e){switch(e.keyCode){case 38:s();break;case 40:c();break;case 13:!function(){var e=new Event("click",{bubbles:!0});n[a].dispatchEvent(e)}();break;case 27:t.innerHTML="",t.style.display="none",a=-1,document.removeEventListener("keydown",r)}};e?(document.onkeydown=!1,document.onclick=!1):(document.onclick=function(e){l.contains(e.target)||d.contains(e.target)||(l.style.display="none",l.innerHTML="",document.onclick=!1)},document.onkeydown=r)}function n(){l.style.display="none",l.innerHTML="",i(l,!0)}var c=function(t){var e=document.createElement("div");return e.classList.add("dest__dummy"),e.dataset.id=t.teacher_id,e.innerHTML='<span class = "dest__dummy-del"></span><span>'+t.teacher_name+"</span>",e.querySelector(".dest__dummy-del").onclick=function(e){e.target.parentNode.remove(),document.querySelector('li.dest__unit[data-id="'+t.teacher_id+'"]')&&document.querySelector('li.dest__unit[data-id="'+t.teacher_id+'"]').classList.remove("dest__selected"),document.querySelector(".dest__dummy")||(n(),s.disabled=!0),e.stopPropagation()},e};o.addEventListener("input",function(){var e=this.value;if(document.querySelector("div.dest__dummy")||e||n(),3<=e.length){var t=r("#course").val();u.call([{methodname:"local_sharewith_autocomplete_teachers",args:{activityid:a,courseid:t,searchstring:e},done:function(e){!function(e){l.innerHTML="",i(l,!0);var t,n=JSON.parse(e);for(t in n){var a=document.createElement("li");a.dataset.id=n[t].teacher_id,a.classList.add("dest__unit"),a.innerHTML='<div class = "dest__img" ><img src = "'+M.cfg.wwwroot+n[t].teacher_url+'" alt = ""></div><span class = "dest__name">'+n[t].teacher_name+"</span>",d.querySelector('div.dest__dummy[data-id="'+n[t].teacher_id+'"]')&&a.classList.add("dest__selected"),l.style.display="block",l.appendChild(a)}l.onclick=function(e){for(var t=e.target;"UL"!=t.tagName;){if("LI"==t.tagName){if(t.classList.contains("dest__selected"))return;var a=c(n[t.dataset.id]);t.classList.add("dest__selected"),d.appendChild(a),s.disabled=!1,o.value=""}t=t.parentNode}},i(l)}(e)},fail:p.exception}])}}),s.addEventListener("click",function(){var e=document.querySelector(".loading_dots"),t=Array.from(document.querySelectorAll(".dest__dummy")),a=[];s.disabled=!0,e.classList.remove("d-none"),t.forEach(function(e){a.push(e.dataset.id)});var n=r("#send_popup_activity_id").val(),o=r("#send_popup_course_id").val(),i=r("#send_popup_message").val();u.call([{methodname:"local_sharewith_submit_teachers",args:{activityid:n,courseid:o,teachersid:JSON.stringify(a),message:i},done:function(){e.classList.add("d-none"),s.classList.add("prof__btn--success"),s.innerHTML=M.util.get_string("sent","local_sharewith"),t.forEach(function(e){e.remove()}),h.approveState()},fail:function(){s.classList.add("prof__btn--error"),s.innerHTML=M.util.get_string("fails","local_sharewith")}}]),l.style.display="none"})}}}});