define(["jquery","core/str","core/ajax","local_sharewith/modal","core/notification"],function(a,b,c,d,e){return b.get_strings([{key:"sent",component:"local_sharewith"},{key:"fails",component:"local_sharewith"},{key:"sharing_sent_successfully",component:"local_sharewith"},{key:"selectcourse",component:"local_sharewith"},{key:"selecttopic",component:"local_sharewith"}]).done(),{ICON:{spinner:"circle-loading",component:"local_sharewith"},selectCategory:function(){var e=d.getBody(),f=function(c){var f=Object.values(JSON.parse(c.categories));d.init(),b.get_string("selectioncategories","local_sharewith").done(function(a){d.getTitle().text(a)}),e.append(a('<select class = "categories form-control"></select>')),f.forEach(function(b){e.find(".categories").append(a("<option data-categoryid ="+b.id+">"+b.name+"</option>"))}),this.setHandler("copyCourseToCategory")}.bind(this);c.call([{methodname:"local_sharewith_get_categories",args:{},done:f,fail:f}])},copyCourseToCategory:function(){var a=this,e=d.getModal().find(":selected").attr("data-categoryid"),f=d.getBody();a.addSpinner(f);var g=function(a){a.result?(b.get_string("succesfullycopied","local_sharewith").done(function(a){f.text(a)}),d.approveState()):(d.errorTextState(),f.text(a.text))};c.call([{methodname:"local_sharewith_add_sharewith_task",args:{sourcecourseid:Number(this.getCurrentCourse()),categoryid:Number(e),type:"coursecopy"},done:g,fail:g}])},selectCourse:function(e){var f=a(e).parents(".activity").find('[data-itemtype="activityname"]').data("itemid"),g=a(e).parents(".section").find('[data-itemtype="sectionname"]').data("itemid"),h=d.getBody(),i=function(c){var i=JSON.parse(c.courses);d.init(),"copySection"===a(e).data("ref")?(this.setHandler("copySectionToCourse"),b.get_string("selectcourse","local_sharewith").done(function(a){d.getTitle().text(a)})):(this.setHandler("copySectionToCourse"),b.get_string("selectcourse_and_section","local_sharewith").done(function(a){d.getTitle().text(a)})),h.append(a('<p>select course</p><select data-handler="selectSection" class = "courses form-control"></select>')).attr("data-cmid",f).attr("data-sectionid",g).css("min-height","100px"),i.forEach(function(b){h.find(".courses").append(a("<option data-courseid ="+b.id+">"+b.fullname+"</option>"))}),"copySection"!==a(e).data("ref")&&(h.append(a('<p>select section</p><select class = "sections form-control"></select>')),this.setHandler("copyActivityToCourse"),this.selectSection(a('[data-handler="selectSection"]')))}.bind(this);c.call([{methodname:"local_sharewith_get_courses",args:{},done:i,fail:i}])},selectSection:function(){var b=d.getBody(),e=b.find(":selected").attr("data-courseid"),f=function(c){var d=JSON.parse(c.sections);b.find(".sections").html(""),d.forEach(function(c){b.find(".sections").append(a("<option data-sectionid ="+c.section_id+">"+c.section_name+"</option>"))})};c.call([{methodname:"local_sharewith_get_sections",args:{courseid:Number(e)},done:f,fail:f}])},selectTeacher:function(e){var f=a(e).parents(".activity").find('[data-itemtype="activityname"]').data("itemid"),g=a("#course").val(),h=d.getBody();d.cancelState();var i=function(a){var c=JSON.parse(a);d.init(),this.setHandler("copySectionToCourse"),b.get_string("selectteacher","local_sharewith").done(function(a){d.getTitle().text(a)}),h.append(c.html),this.selectDestination(f)}.bind(this);c.call([{methodname:"local_sharewith_get_teachers",args:{activityid:f,courseid:g},done:i,fail:i}])},saveActivity:function(e){var f=e.dataset.sharing,g=d.getBody(),h=function(c){var h=JSON.parse(c.courses);d.init(),g.append(a('<input type="hidden" name="shareid" value="'+f+'">')),"copySection"===a(e).data("ref")?(this.setHandler("copySectionToCourse"),b.get_string("selectcourse","local_sharewith").done(function(a){d.getTitle().text(a)})):(this.setHandler("copySectionToCourse"),b.get_string("selectcourse_and_section","local_sharewith").done(function(a){d.getTitle().text(a)})),g.append(a("<p>"+M.util.get_string("selectcourse","local_sharewith")+'</p><select data-handler="selectSection" class = "courses form-control"></select>')).css("min-height","100px"),h.forEach(function(b){g.find(".courses").append(a("<option data-courseid ="+b.id+">"+b.fullname+"</option>"))}),"copySection"!==a(e).data("ref")&&(g.append(a("<p>"+M.util.get_string("selecttopic","local_sharewith")+'</p><select class = "sections form-control"></select>')),this.setHandler("saveActivityToCourse"),this.selectSection(a('[data-handler="selectSection"]')))}.bind(this);c.call([{methodname:"local_sharewith_get_courses",args:{},done:h,fail:h}])},saveActivityToCourse:function(){var e=d.getBody(),f=a('input[name="shareid"]').val(),g=e.find(":selected")[0].dataset.courseid,h=e.find(":selected")[1].dataset.sectionid,i=function(a){a.result>0?(b.get_string("succesfullyshared","local_sharewith").done(function(a){e.text(a)}),d.approveState()):(d.errorTextState(),e.text(a.text))};c.call([{methodname:"local_sharewith_add_saveactivity_task",args:{courseid:Number(g),sectionid:Number(h),shareid:Number(f),type:"activityshare"},done:i,fail:i}])},copyActivityToCourse:function(){var a=d.getBody(),e=a.data("cmid"),f=a.find(":selected")[0].dataset.courseid,g=a.find(":selected")[1].dataset.sectionid,h=function(c){c.result?(b.get_string("succesfullycopied","local_sharewith").done(function(b){a.text(b)}),d.approveState()):(d.errorTextState(),a.text(c.text))};c.call([{methodname:"local_sharewith_add_sharewith_task",args:{courseid:Number(f),sourcecourseid:Number(this.getCurrentCourse()),sectionid:Number(g),sourceactivityid:Number(e),type:"activitycopy"},done:h,fail:h}])},copySectionToCourse:function(){var a=d.getBody(),e=a.data("sectionid"),f=a.find(":selected").data("courseid"),g=function(c){c.result?(b.get_string("succesfullycopied","local_sharewith").done(function(b){a.text(b)}),d.approveState()):(d.errorTextState(),a.text(c.text))};c.call([{methodname:"local_sharewith_add_sharewith_task",args:{courseid:Number(f),sourcecourseid:Number(this.getCurrentCourse()),sourcesectionid:Number(e),type:"sectioncopy"},done:g,fail:g}])},addSpinner:function(b){var c=a("<img/>").attr("src",M.util.image_url(this.ICON.spinner,this.ICON.component)).addClass("mx-auto spinner");return b.html(""),b.append(c),c.fadeIn().css("display","block"),c},getCurrentCourse:function(){var b=a("body").attr("class"),c=b.match(/course-\d+/gi)[0].replace(/\D+/,"");return c},setHandler:function(a){d.getSubmit().attr("data-handler",a)},selectDestination:function(b){var f=3,g=document.querySelector(".prof__form"),h=document.querySelector("input.prof__input"),i=document.querySelector(".prof__tag-wrap"),j=document.createElement("ul"),k=document.querySelector("#btnSendResult");if(g){j.classList.add("dest__result-block"),g.appendChild(j);var l=function(a,b){var c=Array.from(document.querySelectorAll("form"));c.forEach(function(b){b.contains(a)&&(b.onkeydown=function(a){13==a.keyCode&&a.preventDefault()})});var d=0,e=Array.from(a.children);e.forEach(function(a){a.tabIndex=0}),a.onmouseover=function(a){a.target.focus(),e.forEach(function(a,b){a.onfocus=function(){d=b}})};var f=function(){e[d].blur()},g=function(){e[d].focus()},h=function(){d<=0||(e[d-1].classList.contains("dest__selected")?(d--,h()):(f(),d--,g()))},k=function(){d>=e.length-1||(e[d+1].classList.contains("dest__selected")?(d++,k()):(f(),d++,g()))},l=function(){var a=new Event("click",{bubbles:!0});e[d].dispatchEvent(a)},m=function(){a.innerHTML="",a.style.display="none",d=-1,document.removeEventListener("keydown",n)},n=function(a){switch(a.keyCode){case 38:h();break;case 40:k();break;case 13:l();break;case 27:m()}},o=function(a){j.contains(a.target)||i.contains(a.target)||(j.style.display="none",j.innerHTML="",document.onclick=!1)};b?(document.onkeydown=!1,document.onclick=!1):(document.onclick=o,document.onkeydown=n)},m=function(){j.style.display="none",j.innerHTML="",l(j,!0)},n=function(a){j.innerHTML="",l(j,!0);var b,c=JSON.parse(a);for(b in c){var d=document.createElement("li");d.dataset.id=c[b].id,d.classList.add("dest__unit"),d.innerHTML='<div class = "dest__img" ><img src = "'+M.cfg.wwwroot+c[b].teacher_url+'" alt = ""></div><span class = "dest__name">'+c[b].teacher_name+"</span>",i.querySelector('div.dest__dummy[data-id="'+c[b].id+'"]')&&d.classList.add("dest__selected"),j.style.display="block",j.appendChild(d)}j.onclick=function(a){for(var b=a.target;"UL"!=b.tagName;){if("LI"==b.tagName){if(b.classList.contains("dest__selected"))return;var d=o(c[b.dataset.id]);b.classList.add("dest__selected"),i.appendChild(d),k.disabled=!1,h.value=""}b=b.parentNode}},l(j)},o=function(a){var b=document.createElement("div");return b.classList.add("dest__dummy"),b.dataset.id=a.id,b.innerHTML='<span class = "dest__dummy-del"></span><span>'+a.teacher_name+"</span>",b.querySelector(".dest__dummy-del").onclick=function(b){b.target.parentNode.remove(),document.querySelector('li.dest__unit[data-id="'+a.id+'"]')&&document.querySelector('li.dest__unit[data-id="'+a.id+'"]').classList.remove("dest__selected"),document.querySelector(".dest__dummy")||(m(),k.disabled=!0),b.stopPropagation()},b};h.addEventListener("input",function(){var d=this.value;if(document.querySelector("div.dest__dummy")||d||m(),d.length>=f){var g=a("#course").val();c.call([{methodname:"local_sharewith_autocomplete_teachers",args:{activityid:b,courseid:g,searchstring:d},done:function(a){n(a)},fail:e.exception}])}}),k.addEventListener("click",function(){var b=document.querySelector(".loading_dots"),e=Array.from(document.querySelectorAll(".dest__dummy")),f=[];k.disabled=!0,b.classList.remove("d-none"),e.forEach(function(a){f.push(a.dataset.id)});var g=a("#send_popup_activity_id").val(),h=a("#send_popup_courseid").val(),i=a("#send_popup_message").val();c.call([{methodname:"local_sharewith_submit_teachers",args:{activityid:g,courseid:h,teachersid:JSON.stringify(f),message:i},done:function(){b.classList.add("d-none"),k.classList.add("prof__btn--success"),k.innerHTML=M.util.get_string("sent","local_sharewith"),e.forEach(function(a){a.remove()}),d.approveState()},fail:function(){k.classList.add("prof__btn--error"),k.innerHTML=M.util.get_string("fails","local_sharewith")}}]),j.style.display="none"})}}}});