define ("local_sharewith/copyinstance",["jquery","core/str","core/ajax","core/notification","local_sharewith/modal"],function(a,b,c,d,e){return{init:function init(){var a=document.querySelector("body");a.addEventListener("click",function(b){var c=b.target;while(a.contains(c)){if(c.classList.contains("selectCategory")){this.selectCategory();return}switch(c.dataset.handler){case"selectCourseForSection":this.selectCourseForSection(c);break;case"copySectionToCourse":this.copySectionToCourse();break;case"openShareWith":this.openShareWith(c);break;case"selectCourse":this.selectCourse(c);break;case"selectSection":this.selectSection();break;case"copyActivityToCourse":this.copyActivityToCourse();break;case"copyCourseToCategory":this.copyCourseToCategory();break;}c=c.parentNode}}.bind(this));this.typeMessage()},selectCourseForSection:function selectCourseForSection(b){var f=a(b).parents(".section").find("[data-itemtype=\"sectionname\"]").data("itemid");a(e.modalContent).attr("data-sectionid",f);c.call([{methodname:"local_sharewith_get_courses",args:{},done:function renderPopup(a){var b={copySection:!0,courses:JSON.parse(a.courses)};e.render(e.template.copyinstance,b).done(e.triggerBtn.click())},fail:d.exception}])},copySectionToCourse:function copySectionToCourse(){var b=a(e.modalContent),f=b.attr("data-sectionid"),g=b.find(":selected").data("courseid");e.addBtnSpinner();c.call([{methodname:"local_sharewith_add_sharewith_task",args:{courseid:+g,sourcecourseid:+this.getCurrentCourse(),sourcesectionid:+f,type:"sectioncopy"},done:function renderPopup(a){var b=e.template.error,c={title:M.util.get_string("eventsectioncopy","local_sharewith"),text:M.util.get_string("system_error_contact_administrator","local_sharewith")};if(a.result){b=e.template.confirm;c={title:M.util.get_string("eventsectioncopy","local_sharewith"),text:M.util.get_string("section_copied_to_course","local_sharewith")}}e.render(b,c)},fail:d.exception}])},openShareWith:function openShareWith(b){var c=a(b).parents(".activity").find("[data-itemtype=\"activityname\"]").data("itemid"),d=a(b).parents(".section").find("[data-itemtype=\"sectionname\"]").data("itemid"),f={activitysending:+b.dataset.activitysending},g=e.template.selector;a(e.modalContent).attr("data-cmid",c).attr("data-sectionid",d);e.render(g,f).done(e.triggerBtn.click())},selectCourse:function selectCourse(b){var f=this;c.call([{methodname:"local_sharewith_get_courses",args:{},done:function renderPopup(c){var d={courses:JSON.parse(c.courses),copyActivity:!0};if(b.dataset.activitysharing){var g=b.dataset.activitysharing;a(e.modalContent).attr("data-cmid",g);d.hidebackbtn=!0;e.render(e.template.copyinstance,d).done(e.triggerBtn.click()).done(f.selectSection)}else{e.render(e.template.copyinstance,d).done(f.selectSection)}},fail:d.exception}])},selectSection:function selectSection(){var b=a(e.modalContent),f=b.find(":selected").attr("data-courseid");if(!f){f=this.getCurrentCourse()}c.call([{methodname:"local_sharewith_get_sections",args:{courseid:+f},done:function renderPopup(c){var d=JSON.parse(c.sections);b.find(".sections").html("");d.forEach(function(c){b.find(".sections").append(a("<option data-sectionid ="+c.section_id+">"+c.section_name+"</option>"))})},fail:d.exception}])},copyActivityToCourse:function copyActivityToCourse(){var b=a(e.modalContent),f=b.attr("data-cmid"),g=b.find(".courses option:selected").attr("data-courseid"),h=b.find(".sections option:selected").attr("data-sectionid");e.addBtnSpinner();c.call([{methodname:"local_sharewith_add_sharewith_task",args:{courseid:+g,sourcecourseid:+this.getCurrentCourse(),sectionid:+h,sourceactivityid:+f,type:"activitycopy"},done:function renderPopup(a){var b={title:M.util.get_string("eventdublicatetoteacher","local_sharewith")},c=e.template.error;switch(a.result){case 0:b.text=M.util.get_string("system_error_contact_administrator","local_sharewith");break;case 1:b.text=M.util.get_string("error_coursecopy","local_sharewith");break;case 2:b.text=M.util.get_string("error_sectioncopy","local_sharewith");break;case 3:b.text=M.util.get_string("error_activitycopy","local_sharewith");break;case 4:b.text=M.util.get_string("error_permission_allow_copy","local_sharewith");break;case 10:b.text=M.util.get_string("activity_copied_to_course","local_sharewith");c=e.template.confirm;break;}e.render(c,b)},fail:d.exception}])},selectCategory:function selectCategory(){c.call([{methodname:"local_sharewith_get_categories",args:{},done:function renderPopup(a){var b={hidebackbtn:!0,copyCourse:!0,categories:JSON.parse(a.categories)},c=e.template.copyinstance;if(!a.result){b={hidebackbtn:!0,copyCourse:!0,title:M.util.get_string("eventcoursecopy","local_sharewith"),text:M.util.get_string("no_accessible_category","local_sharewith")};c=e.template.error}e.render(c,b).done(e.triggerBtn.click())},fail:d.exception}])},copyCourseToCategory:function copyCourseToCategory(){var b=a(e.modalContent).find(":selected").attr("data-categoryid");c.call([{methodname:"local_sharewith_add_sharewith_task",args:{sourcecourseid:+this.getCurrentCourse(),categoryid:+b,type:"coursecopy"},done:function renderPopup(a){var b={title:M.util.get_string("eventcoursecopy","local_sharewith"),text:M.util.get_string("system_error_contact_administrator","local_sharewith")},c=e.template.error;if(a.result){b={title:M.util.get_string("eventcoursecopy","local_sharewith"),text:M.util.get_string("course_copied_to_section","local_sharewith")};c=e.template.confirm}e.render(c,b)},fail:d.exception}])},typeMessage:function typeMessage(){var a=window.location.href,c=new URL(a),e=c.searchParams.get("swactivityname");if(e){var f=document.querySelector("textarea[data-region=\"send-message-txt\"]");b.get_string("ask_question_before_copying","local_sharewith",{activityname:e}).done(function(a){var b=0;(function c(){if(b<a.length){f.innerHTML+=a.charAt(b);b++;setTimeout(c,30)}else{f.focus()}})()}).fail(d.exception)}},getCurrentCourse:function getCurrentCourse(){var b=a("body").attr("class"),c=b.match(/course-\d+/gi)[0].replace(/\D+/,"");return c}}});
//# sourceMappingURL=copyinstance.min.js.map
